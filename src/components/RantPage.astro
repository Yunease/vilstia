---
import type { CollectionEntry } from "astro:content";
import { getMessPosts } from "@utils/mess-utils";
import CustomPagination from "./control/CustomPagination.astro";
import RantCard from "./RantCard.astro";

interface Props {
	page: {
		data: CollectionEntry<"posts">[];
		currentPage: number;
		lastPage: number;
		url: {
			prev: string | null;
			next: string | null;
		};
	};
}

const { page } = Astro.props;

// Mood颜色配置（与RantCard保持一致）
const MOOD_COLORS: { [key: string]: string } = {
	焦躁: "#E06C75",
	消沉: "#7F8C8D",
	怨恨: "#C792EA",
	开心: "#3CB371",
	平和: "#FFB6C1",
	振奋: "#F4A460",
};

//我认为应该合并一下情绪，让情绪比例为1：1
//正面情绪：平和，开心，振奋（生理上的）
//负面情绪：焦躁（焦虑+烦躁），消沉（难过+摆烂），怨恨

//它们的颜色也应该重写，我的原则是保留原有的样式尽可能不变：
// 开心: "#3CB371",
// 平和: "#FFB6C1",
// 振奋："#E06C75" 要比这个更亮一点,

// 焦躁: "#E06C75",
// 消沉: "#7F8C8D",
// 怨恨: "#C792EA",
// 接下来我应该重写已有的情绪部分，保持和新版的情绪一致。
// 不过，我应该先备份原有的颜色，就算有git也应该备份。

// const MOOD_COLORS: { [key: string]: string } = {
// 	开心: "#3CB371",
// 	烦躁: "#E06C75",
// 	难过: "#5A6FB2",
// 	焦虑: "#D9822B",
// 	摆烂: "#7F8C8D",
// 	怨恨: "#C792EA",
// 	平和: "#FFB6C1",
// };

// 获取所有mood统计数据
const allMessPosts = await getMessPosts();
const moodCounts: { [key: string]: number } = {};
allMessPosts.forEach((post) => {
	const mood = post.data.mood || "烦躁";
	moodCounts[mood] = (moodCounts[mood] || 0) + 1;
});

const len = page.data.length;
let delay = 0;
const interval = 100;

//获取一共有多少md文件，优化性能不用每次都计算
const totalCount = Object.values(moodCounts).reduce(
	(sum, count) => sum + count,
	0,
);
---

<div class="flex flex-col">
	<!-- Page Title and Description -->
	<div class="card-base p-6 mb-8 onload-animation">
		<h1 class="text-3xl font-bold text-[var(--primary)] mb-3">心灵碎片</h1>
		<p class="text-[var(--text-neutral)] dark:text-white/80 leading-relaxed">
			情绪的碎片化记录，在这里记录日常的喜怒哀乐和瞬息万变的想法。
		</p>
		<p class="text-[var(--text-neutral)] dark:text-white/80 leading-relaxed">
			这只是一个吐槽版。
		</p>
		<!-- Mood 统计 -->
		<div class="mt-4 space-y-2">
			<div class="h-[3px] rounded-full bg-[var(--primary)]"></div>
			<div class="mt-5 space-y-1.5">
				{Object.entries(moodCounts)
					.sort(([, a], [, b]) => b - a)
					.map(([mood, count]) => {
						const moodColor = MOOD_COLORS[mood] || "#F6C177";
						//计算count的字符串长度，用于生成对齐的margin参数
						const countLength = count.toString().length;
						//根据长度计算偏移值
						//基础偏移30px，每多1位减9px
						//如果countLength<4就永远不要动这个9，不然会炸
						const baseMargin = 30;
						const maxLength = 4; // 预设最大长度，应该不会出现超过1w条了
						const offsetMargin = baseMargin - (countLength - 1) * 9;
						//妈的怎么跑不通，调试一下试试。。。
						console.log(`计算出的margin-left：${offsetMargin}px`);
						return (
							<div class="flex items-center gap-2">
								<div class="w-3 h-3 rounded-full bg-[var(--primary)]"></div>
								<span
									class="text-sm font-bold px-2 py-0.5 rounded-full"
									style={`color: ${moodColor}; background-color: ${moodColor}15;`}
								>
									{mood}
								</span>
								<span class="text-[var(--text-neutral)] dark:text-white/80">
									：共{count}条
								</span>
								<span 
									class="text-[var(--text-neutral)] dark:text-white/80"
									style={`margin-left: ${offsetMargin}px;`}
								>
									{(count / totalCount * 100).toFixed(1)}%
								</span>
							</div>
						);
					})}
			</div>
			<div class="Uline flex items-center gap-2">
				<div class="w-3 h-3 rounded-full bg-[var(--primary)]"></div>
				<span
					class="allTheCard text-sm font-bold px-2 py-0.5 rounded-full"
					style="dark:color: #d1d5db; dark:background-color: #1f2937;"
				>
					总计
				</span>
				<span class="text-[var(--text-neutral)] dark:text-white/80">
					：共{Object.values(moodCounts).reduce((sum, count) => sum + count, 0)}条
				</span>
			</div>
		</div>
	</div>

	<div class="transition flex flex-col rounded-[var(--radius-large)] bg-[var(--card-bg)] py-1 md:py-0 md:bg-transparent md:gap-4 mb-4">
		{page.data.map((entry) => (
			<RantCard
				entry={entry}
				class="onload-animation"
				style={`animation-delay: calc(var(--content-delay) + ${delay++ * interval}ms);`}
			></RantCard>
		))}
	</div>
	<CustomPagination
		class="mx-auto onload-animation"
		page={page}
		basePath="/rant"
		style={`animation-delay: calc(var(--content-delay) + ${len * interval}ms)`}
	></CustomPagination>
</div>

<style>
	.Uline{
		margin-bottom:  30px;
	}
	.allTheCard{
		color: #6495ED;
		background-color: #6495ED15;
	}
</style>
